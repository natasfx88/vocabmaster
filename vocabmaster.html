<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabMaster - Sistema de Vocabulario</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700;800&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #C73866;
            --secondary: #FF6B9D;
            --accent: #FFB347;
            --success: #06D6A0;
            --error: #EF476F;
            --bg: #FFF9F5;
            --card: #FFFFFF;
            --text: #2D2D2D;
            --text-light: #6C757D;
            --border: #E0E0E0;
            --sakura: #FFB7C5;
            --matcha: #88B04B;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #FFE5EC 0%, #FFF0F5 50%, #FFF5EE 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: 'üå∏';
            position: fixed;
            top: 10%;
            right: 5%;
            font-size: 8em;
            opacity: 0.05;
            z-index: 0;
            animation: float 6s ease-in-out infinite;
        }

        body::after {
            content: 'üéå';
            position: fixed;
            bottom: 10%;
            left: 5%;
            font-size: 6em;
            opacity: 0.05;
            z-index: 0;
            animation: float 8s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(199, 56, 102, 0.15);
            position: relative;
            border: 3px solid var(--sakura);
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--sakura) 50%, var(--accent) 100%);
            border-radius: 20px 20px 0 0;
        }

        .language-selector {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
        }

        .lang-btn:hover:not(.active) {
            border-color: var(--secondary);
            transform: translateY(-2px);
        }

        h1 {
            font-family: 'Lexend', sans-serif;
            font-size: 3em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: var(--bg);
            border: 2px solid var(--sakura);
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--sakura));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(199, 56, 102, 0.3);
            border-color: transparent;
        }

        .tab:hover:not(.active) {
            background: #FFE5EC;
            border-color: var(--primary);
        }

        .content {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(199, 56, 102, 0.15);
            display: none;
            border: 3px solid var(--sakura);
            position: relative;
        }

        .content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--sakura) 50%, var(--accent) 100%);
            border-radius: 20px 20px 0 0;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-family: 'Lexend', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* GESTI√ìN DE CATEGOR√çAS */
        .categories-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 30px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(199, 56, 102, 0.1);
        }

        .categories-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--sakura) 100%);
            color: white;
        }

        .categories-table th {
            padding: 20px;
            text-align: left;
            font-weight: 700;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .categories-table th:first-child {
            border-radius: 15px 0 0 0;
        }

        .categories-table th:last-child {
            border-radius: 0 15px 0 0;
            text-align: right;
        }

        .categories-table tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* Colores alternados para las filas */
        .categories-table tbody tr:nth-child(odd) {
            background: #FFF9F5;
        }

        .categories-table tbody tr:nth-child(even) {
            background: #FFFFFF;
        }

        .categories-table tbody tr:hover {
            background: linear-gradient(135deg, #FFE5EC 0%, #FFF0F5 100%);
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(199, 56, 102, 0.15);
        }

        .categories-table td {
            padding: 20px;
            border-bottom: 1px solid #FFE5EC;
        }

        .categories-table tbody tr:last-child td {
            border-bottom: none;
        }

        .category-name-cell {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
        }

        .category-words-count {
            color: var(--text-light);
            font-weight: 600;
            font-size: 1em;
        }

        .category-actions-cell {
            text-align: right;
        }

        .category-actions-cell .btn-small {
            margin-left: 10px;
        }

        .btn-small {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--sakura) 100%);
            border: none;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }

        .btn-small:hover {
            background: linear-gradient(135deg, #B23055 0%, #FF9FB1 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(199, 56, 102, 0.3);
        }

        .btn-small.btn-practice-category {
            background: linear-gradient(135deg, var(--matcha) 0%, #A8D08D 100%);
        }

        .btn-small.btn-practice-category:hover {
            background: linear-gradient(135deg, #77A03D 0%, #9AC67B 100%);
            box-shadow: 0 5px 15px rgba(136, 176, 75, 0.3);
        }

        .btn-small.btn-delete-category {
            background: linear-gradient(135deg, #EF476F 0%, #D63659 100%);
        }

        .btn-small.btn-delete-category:hover {
            background: linear-gradient(135deg, #D63659 0%, #C12547 100%);
            box-shadow: 0 5px 15px rgba(239,71,111,0.3);
        }

        .add-category-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary), var(--sakura));
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .add-category-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(199, 56, 102, 0.3);
        }

        .empty-categories {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transition: all 0.5s ease;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102,126,234,0.4);
        }

        .category-card:hover::before {
            top: -100%;
            right: -100%;
        }

        .category-name {
            font-weight: 700;
            font-size: 1.3em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .category-count {
            font-size: 0.9em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .category-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .btn-small {
            padding: 10px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }

        .btn-small:hover {
            background: linear-gradient(135deg, #5568d3 0%, #634a8f 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-small.btn-delete-category {
            background: linear-gradient(135deg, #EF476F 0%, #D63659 100%);
        }

        .btn-small.btn-delete-category:hover {
            background: linear-gradient(135deg, #D63659 0%, #C12547 100%);
            box-shadow: 0 5px 15px rgba(239,71,111,0.3);
        }

        .add-category-card {
            background: var(--bg);
            border: 3px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-category-card:hover {
            border-color: var(--secondary);
            background: #F0F0F0;
        }

        .add-icon {
            font-size: 3em;
            color: var(--text-light);
        }

        /* FORMULARIOS */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(255,107,157,0.1);
        }

        /* Estilo para inputs con conversi√≥n japonesa activa */
        input[data-romaji-enabled="true"] {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(to right, #FFF9F5 0%, #FFE5EC 100%);
            border-color: var(--sakura);
        }

        input[data-romaji-enabled="true"]::placeholder {
            font-family: 'Outfit', sans-serif;
        }

        input[data-romaji-enabled="true"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(199, 56, 102, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* BADGES DE TIPO DE PALABRA */
        .word-type-badge {
            display: inline-block;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .word-type-noun { background: #E3F2FD; color: #1976D2; }
        .word-type-verb { background: #F3E5F5; color: #7B1FA2; }
        .word-type-adjective { background: #E8F5E9; color: #388E3C; }
        .word-type-adverb { background: #FFF3E0; color: #F57C00; }
        .word-type-pronoun { background: #FCE4EC; color: #C2185B; }
        .word-type-particle { background: #E0F2F1; color: #00796B; }
        .word-type-conjunction { background: #F1F8E9; color: #689F38; }
        .word-type-interjection { background: #FFF9C4; color: #F9A825; }
        .word-type-counter { background: #E1BEE7; color: #8E24AA; }
        .word-type-expression { background: #FFEBEE; color: #D32F2F; }

        /* BADGES DE INTENTOS RECIENTES */
        .recent-attempts-cell {
            text-align: center;
        }

        .attempt-badges {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
        }

        .attempt-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
            min-width: 45px;
            text-align: center;
            font-family: 'Lexend', sans-serif;
        }

        .attempt-badge.excellent {
            background: linear-gradient(135deg, #06D6A0 0%, #4ADE80 100%);
            color: white;
        }

        .attempt-badge.good {
            background: linear-gradient(135deg, #FFB347 0%, #FFC93C 100%);
            color: white;
        }

        .attempt-badge.poor {
            background: linear-gradient(135deg, #EF476F 0%, #FF6B9D 100%);
            color: white;
        }

        .no-attempts {
            color: var(--text-light);
            font-size: 0.85em;
            font-style: italic;
        }

        /* Indicador de modo IME japon√©s */
        .ime-indicator {
            position: absolute;
            top: -30px;
            right: 10px;
            font-size: 0.75em;
            color: white;
            font-weight: 600;
            background: var(--primary);
            padding: 4px 12px;
            border-radius: 15px;
            display: none;
            box-shadow: 0 2px 8px rgba(199, 56, 102, 0.3);
        }

        .input-wrapper-jp {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-wrapper-jp:focus-within .ime-indicator {
            display: inline-block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--sakura));
            color: white;
            border-radius: 25px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(199, 56, 102, 0.3);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--sakura);
            border-radius: 25px;
        }

        .btn-secondary:hover {
            background: #FFE5EC;
            border-color: var(--primary);
        }

        /* PALABRAS */
        .words-list {
            margin-top: 30px;
        }

        .words-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9em;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .words-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .words-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .words-table th:first-child {
            border-radius: 12px 0 0 0;
        }

        .words-table th:last-child {
            border-radius: 0 12px 0 0;
            text-align: center;
            width: 100px;
        }

        .words-table tbody tr {
            transition: all 0.2s ease;
        }

        .words-table tbody tr:nth-child(odd) {
            background: #F8F9FA;
        }

        .words-table tbody tr:nth-child(even) {
            background: #FFFFFF;
        }

        .words-table tbody tr:hover {
            background: linear-gradient(135deg, #E8EEFF 0%, #F0E8FF 100%);
        }

        .words-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #E9ECEF;
        }

        .words-table tbody tr:last-child td {
            border-bottom: none;
        }

        .word-cell {
            font-weight: 600;
            color: var(--primary);
        }

        .translation-cell {
            color: var(--text-light);
            font-family: 'Noto Sans JP', sans-serif;
        }

        .kanji-text {
            display: block;
            font-weight: 600;
            color: var(--primary);
            margin-top: 3px;
            font-size: 0.95em;
        }

        .actions-cell {
            text-align: center;
        }

        .btn-delete-word {
            padding: 6px 12px;
            background: linear-gradient(135deg, #EF476F 0%, #D63659 100%);
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }

        .btn-delete-word:hover {
            background: linear-gradient(135deg, #D63659 0%, #C12547 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(239,71,111,0.3);
        }

        .word-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .word-item:hover {
            background: #E9ECEF;
            transform: translateX(5px);
        }

        .word-text {
            font-weight: 600;
            color: var(--primary);
        }

        .translation-text {
            color: var(--text-light);
        }

        .btn-delete {
            padding: 8px 15px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
        }

        .btn-delete:hover {
            background: #D63659;
        }

        /* PR√ÅCTICA */
        .practice-setup {
            max-width: 600px;
            margin: 0 auto;
        }

        .practice-mode-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-option-compact {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option-compact:hover {
            border-color: var(--sakura);
            background: #FFF9F5;
            transform: translateY(-2px);
        }

        .mode-option-compact input[type="radio"] {
            display: none;
        }

        .mode-option-compact:has(input:checked) {
            border-color: var(--primary);
            background: linear-gradient(135deg, #FFE5EC 0%, #FFF0F5 100%);
            box-shadow: 0 3px 10px rgba(199, 56, 102, 0.2);
        }

        .mode-option-compact:has(input:checked) .mode-label {
            color: var(--primary);
            font-weight: 700;
        }

        .mode-option-compact .mode-label {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .checkbox-group {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: white;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .practice-quiz {
            text-align: center;
        }

        .quiz-card {
            background: linear-gradient(135deg, var(--accent) 0%, #FFD96A 100%);
            padding: 40px;
            border-radius: 20px;
            margin: 20px auto 30px;
            box-shadow: 0 10px 30px rgba(255,201,60,0.3);
            max-width: 600px;
            text-align: center;
        }

        .question-counter {
            font-size: 0.85em;
            color: rgba(0,0,0,0.6);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .question {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            font-family: 'Lexend', sans-serif;
        }

        .answer-input {
            width: 100%;
            max-width: 450px;
            padding: 18px;
            font-size: 1.2em;
            text-align: center;
            border: 3px solid white;
            border-radius: 15px;
            margin: 0 auto 15px;
            font-family: 'Noto Sans JP', sans-serif;
            background: white;
            display: block;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--sakura);
            box-shadow: 0 0 0 4px rgba(255, 183, 197, 0.2);
        }

        .answer-input.correct {
            border-color: var(--success);
            background: #E8FFF6;
        }

        .answer-input.incorrect {
            border-color: var(--error);
            background: #FFE8EE;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .feedback {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
            font-size: 1.1em;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s ease;
        }

        .feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        .feedback.correct {
            background: var(--success);
            color: white;
        }

        .feedback.incorrect {
            background: var(--error);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: var(--bg);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 3em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Lexend', sans-serif;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9em;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* HISTORIAL DE CATEGOR√çAS */
        .history-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .history-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg);
        }

        .history-category-name {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Lexend', sans-serif;
        }

        .history-meta {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .history-date {
            color: var(--text-light);
            font-size: 0.9em;
        }

        .history-score {
            background: linear-gradient(135deg, var(--accent) 0%, #FFD96A 100%);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1em;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-stat-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .history-stat-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Lexend', sans-serif;
        }

        .history-stat-value.correct {
            color: var(--success);
        }

        .history-stat-value.incorrect {
            color: var(--error);
        }

        .history-stat-value.skipped {
            color: #FFA500;
        }

        .history-stat-label {
            font-size: 0.85em;
            color: var(--text-light);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-mistakes {
            background: #FFF5F5;
            border-left: 4px solid var(--error);
            padding: 15px;
            border-radius: 8px;
        }

        .history-mistakes-title {
            font-weight: 700;
            color: var(--error);
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .history-mistake-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .history-mistake-item {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            border: 1px solid #FFE0E6;
        }

        .history-mistake-word {
            font-weight: 600;
            color: var(--primary);
        }

        .history-mistake-translation {
            color: var(--text-light);
            margin-left: 5px;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .no-history {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .no-history-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* TABLA DE HISTORIAL */
        .history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(199, 56, 102, 0.1);
        }

        .history-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--sakura) 100%);
            color: white;
        }

        .history-table th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-table th:first-child {
            border-radius: 15px 0 0 0;
        }

        .history-table th:last-child {
            border-radius: 0 15px 0 0;
            text-align: center;
        }

        .history-table tbody tr {
            transition: all 0.3s ease;
        }

        .history-table tbody tr:nth-child(odd) {
            background: #FFF9F5;
        }

        .history-table tbody tr:nth-child(even) {
            background: #FFFFFF;
        }

        .history-table tbody tr:hover {
            background: linear-gradient(135deg, #FFE5EC 0%, #FFF0F5 100%);
            transform: translateX(3px);
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid #FFE5EC;
            font-size: 0.95em;
        }

        .history-table tbody tr:last-child td {
            border-bottom: none;
        }

        .history-table .category-cell {
            font-weight: 700;
            color: var(--primary);
        }

        .history-table .date-cell {
            color: var(--text-light);
            font-size: 0.85em;
        }

        .history-table .stat-cell {
            text-align: center;
            font-weight: 600;
        }

        .history-table .stat-cell.correct {
            color: var(--success);
        }

        .history-table .stat-cell.incorrect {
            color: var(--error);
        }

        .history-table .stat-cell.skipped {
            color: #FFA500;
        }

        .history-table .accuracy-cell {
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
        }

        .history-table .actions-cell {
            text-align: center;
        }

        .btn-view-mistakes {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--sakura) 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view-mistakes:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(199, 56, 102, 0.3);
        }

        /* MODAL DE ERRORES */
        .mistakes-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .mistakes-modal-overlay.show {
            display: flex;
        }

        .mistakes-modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(199, 56, 102, 0.3);
        }

        .mistakes-modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            font-family: 'Lexend', sans-serif;
        }

        .mistakes-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mistake-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--error);
        }

        .mistake-word {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .mistake-translation {
            color: var(--text-light);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.95em;
        }

        .mistake-skipped-badge {
            display: inline-block;
            background: #FFA500;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 8px;
            font-weight: 600;
        }

        /* FOOTER */
        footer {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin-top: 40px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(199, 56, 102, 0.1);
            border: 2px solid var(--sakura);
        }

        footer::before {
            content: '';
            display: block;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--sakura) 50%, var(--accent) 100%);
            border-radius: 20px 20px 0 0;
            margin: -25px -25px 20px -25px;
        }

        .footer-content {
            color: var(--text);
        }

        .footer-creator {
            font-size: 1em;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .footer-tip {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .footer-btc {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: var(--text);
            background: var(--bg);
            padding: 8px 15px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid var(--sakura);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .footer-btc:hover {
            background: #FFE5EC;
            transform: scale(1.02);
        }

        .footer-btc:active {
            transform: scale(0.98);
        }

        /* RESULTADOS */
        .results-screen {
            text-align: center;
            padding: 40px;
        }

        .results-title {
            font-family: 'Lexend', sans-serif;
            font-size: 2.5em;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .results-percentage {
            font-size: 5em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Lexend', sans-serif;
        }

        .failed-words {
            background: var(--bg);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: left;
        }

        .failed-word-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Lexend', sans-serif;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .categories-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .word-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-selector">
                <button class="lang-btn active" onclick="changeLanguage('en')" id="lang-en">English</button>
                <button class="lang-btn" onclick="changeLanguage('ja')" id="lang-ja">Êó•Êú¨Ë™û</button>
            </div>
            
            <h1 data-i18n="app_title">üìö VocabMaster</h1>
            <p class="subtitle" data-i18n="app_subtitle">Tu sistema personal de aprendizaje de vocabulario</p>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('categories')" data-i18n="tab_categories">üè∑Ô∏è Categor√≠as</button>
                <button class="tab" onclick="showTab('practice')" data-i18n="tab_practice">üéØ Practicar</button>
                <button class="tab" onclick="showTab('mistakes')" data-i18n="tab_mistakes">‚ùå Mis Errores</button>
                <button class="tab" onclick="showTab('stats')" data-i18n="tab_stats">üìä Estad√≠sticas</button>
            </div>
        </header>

        <!-- CATEGOR√çAS -->
        <div id="categories-content" class="content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 class="section-title" data-i18n="section_my_categories" style="margin-bottom: 0;">üìÇ Mis Categor√≠as</h2>
                <button class="add-category-btn" onclick="openAddCategoryModal()">
                    <span style="font-size: 1.5em;">+</span>
                    <span data-i18n="btn_new_category">Nueva Categor√≠a</span>
                </button>
            </div>
            
            <div id="categories-container">
                <!-- Tabla de categor√≠as se renderizar√° aqu√≠ -->
            </div>
        </div>

        <!-- PR√ÅCTICA -->
        <div id="practice-content" class="content">
            <div id="practice-setup" class="practice-setup">
                <h2 class="section-title" data-i18n="section_configure_practice">üéØ Configurar Pr√°ctica</h2>
                
                <div style="margin-bottom: 25px;">
                    <div class="practice-mode-selector">
                        <label class="mode-option-compact">
                            <input type="radio" name="practice-mode" value="en-ja" checked>
                            <span class="mode-label" data-i18n="practice_mode_en_ja">EN ‚Üí JP</span>
                        </label>
                        <label class="mode-option-compact">
                            <input type="radio" name="practice-mode" value="ja-en">
                            <span class="mode-label" data-i18n="practice_mode_ja_en">JP ‚Üí EN</span>
                        </label>
                        <label class="mode-option-compact">
                            <input type="radio" name="practice-mode" value="mixed">
                            <span class="mode-label" data-i18n="practice_mode_mixed">Mixed</span>
                        </label>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1em; font-weight: 700;" data-i18n="select_categories_title">Select Categories</h3>
                
                <div class="checkbox-group" id="category-checkboxes">
                    <p style="color: var(--text-light); text-align: center;" data-i18n="no_categories_available">No hay categor√≠as disponibles</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPractice()" data-i18n="btn_start_practice">Iniciar Pr√°ctica</button>
                    <button class="btn btn-secondary" onclick="selectAllCategories()" data-i18n="btn_select_all">Seleccionar Todas</button>
                </div>
            </div>

            <div id="practice-quiz" style="display: none;">
                <!-- Quiz aparecer√° aqu√≠ -->
            </div>
        </div>

        <!-- ERRORES -->
        <div id="mistakes-content" class="content">
            <h2 class="section-title" data-i18n="section_words_with_mistakes">‚ùå Palabras con Errores</h2>
            <div id="mistakes-list">
                <div class="empty-state">
                    <div class="empty-icon">‚ú®</div>
                    <p data-i18n="no_mistakes_yet">¬°No tienes errores registrados a√∫n!</p>
                    <p data-i18n="practice_to_track">Practica para llevar un registro de tus fallos.</p>
                </div>
            </div>
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="practiceMistakes()" id="practice-mistakes-btn" style="display: none;" data-i18n="btn_practice_mistakes">
                    Practicar Solo Errores
                </button>
                <button class="btn btn-secondary" onclick="clearMistakes()" data-i18n="btn_clear_mistakes">
                    Limpiar Errores
                </button>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div id="stats-content" class="content">
            <h2 class="section-title" data-i18n="section_general_stats">üìä Estad√≠sticas Generales</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="total-categories">0</div>
                    <div class="stat-label" data-i18n="stat_categories">Categor√≠as</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-words">0</div>
                    <div class="stat-label" data-i18n="stat_total_words">Palabras Totales</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-practiced">0</div>
                    <div class="stat-label" data-i18n="stat_times_practiced">Veces Practicadas</div>
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 40px;" data-i18n="section_category_history">üìà Historial por Categor√≠a</h2>
            <div id="category-history-container">
                <!-- Historial se renderizar√° aqu√≠ -->
            </div>
        </div>

        <!-- MODAL A√ëADIR CATEGOR√çA -->
        <div id="add-category-modal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title" data-i18n="modal_new_category">Nueva Categor√≠a</h3>
                <div class="form-group">
                    <label data-i18n="label_category_name">Nombre de la Categor√≠a</label>
                    <input type="text" id="category-name-input" data-i18n-placeholder="placeholder_category_name" placeholder="Ej: GENKI Lecci√≥n 9">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveCategory()" data-i18n="btn_save">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeModal('add-category-modal')" data-i18n="btn_cancel">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- MODAL A√ëADIR PALABRA -->
        <div id="add-word-modal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title" data-i18n="modal_add_word">A√±adir Palabra</h3>
                <div class="form-group">
                    <label data-i18n="label_word_term">Palabra/T√©rmino</label>
                    <input type="text" id="word-input" data-i18n-placeholder="placeholder_word" placeholder="Ej: hot (weather)">
                </div>
                <div class="form-group">
                    <label data-i18n="label_translation">Traducci√≥n (Hiragana/Katakana)</label>
                    <div class="input-wrapper-jp">
                        <span class="ime-indicator">„ÅÇ JP</span>
                        <input type="text" id="translation-input" data-i18n-placeholder="placeholder_translation" placeholder="Ej: „ÅÇ„Å§„ÅÑ">
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="label_kanji">Kanji (Opcional)</label>
                    <div class="input-wrapper-jp">
                        <span class="ime-indicator">„ÅÇ JP</span>
                        <input type="text" id="kanji-input" data-i18n-placeholder="placeholder_kanji" placeholder="Ej: Êöë„ÅÑ">
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="label_word_type">Word Type (Optional)</label>
                    <select id="word-type-select">
                        <option value="">-</option>
                        <option value="noun" data-i18n="word_type_noun">Noun</option>
                        <option value="verb" data-i18n="word_type_verb">Verb</option>
                        <option value="adjective" data-i18n="word_type_adjective">Adjective</option>
                        <option value="adverb" data-i18n="word_type_adverb">Adverb</option>
                        <option value="pronoun" data-i18n="word_type_pronoun">Pronoun</option>
                        <option value="particle" data-i18n="word_type_particle">Particle</option>
                        <option value="conjunction" data-i18n="word_type_conjunction">Conjunction</option>
                        <option value="interjection" data-i18n="word_type_interjection">Interjection</option>
                        <option value="counter" data-i18n="word_type_counter">Counter</option>
                        <option value="expression" data-i18n="word_type_expression">Expression</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveWord()" data-i18n="btn_save">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeModal('add-word-modal')" data-i18n="btn_cancel">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- MODAL VER CATEGOR√çA -->
        <div id="view-category-modal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
                <h3 class="modal-title" id="modal-category-title">Categor√≠a</h3>
                <button class="btn btn-primary" onclick="openAddWordModal()" style="margin-bottom: 20px;" data-i18n="btn_add_word">
                    + A√±adir Palabra
                </button>
                <div id="category-words-list" class="words-list">
                    <!-- Palabras aqu√≠ -->
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeModal('view-category-modal')" data-i18n="btn_close">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <div class="footer-content">
                <div class="footer-creator">Created by Natasfx üå∏</div>
                <div class="footer-tip">Feel free to tip:</div>
                <div class="footer-btc" onclick="copyBtcAddress(this)" title="Click to copy">
                    1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Sistema de conversi√≥n Romaji a Hiragana (sin dependencias externas)
        const romajiToHiragana = {
            // Vocales
            'a': '„ÅÇ', 'i': '„ÅÑ', 'u': '„ÅÜ', 'e': '„Åà', 'o': '„Åä',
            
            // K
            'ka': '„Åã', 'ki': '„Åç', 'ku': '„Åè', 'ke': '„Åë', 'ko': '„Åì',
            'kya': '„Åç„ÇÉ', 'kyu': '„Åç„ÇÖ', 'kyo': '„Åç„Çá',
            
            // G
            'ga': '„Åå', 'gi': '„Åé', 'gu': '„Åê', 'ge': '„Åí', 'go': '„Åî',
            'gya': '„Åé„ÇÉ', 'gyu': '„Åé„ÇÖ', 'gyo': '„Åé„Çá',
            
            // S
            'sa': '„Åï', 'shi': '„Åó', 'si': '„Åó', 'su': '„Åô', 'se': '„Åõ', 'so': '„Åù',
            'sha': '„Åó„ÇÉ', 'shu': '„Åó„ÇÖ', 'sho': '„Åó„Çá',
            
            // Z
            'za': '„Åñ', 'ji': '„Åò', 'zi': '„Åò', 'zu': '„Åö', 'ze': '„Åú', 'zo': '„Åû',
            'ja': '„Åò„ÇÉ', 'ju': '„Åò„ÇÖ', 'jo': '„Åò„Çá',
            
            // T
            'ta': '„Åü', 'chi': '„Å°', 'ti': '„Å°', 'tsu': '„Å§', 'tu': '„Å§', 'te': '„Å¶', 'to': '„Å®',
            'cha': '„Å°„ÇÉ', 'chu': '„Å°„ÇÖ', 'cho': '„Å°„Çá',
            
            // D
            'da': '„Å†', 'di': '„Å¢', 'du': '„Å•', 'de': '„Åß', 'do': '„Å©',
            
            // N
            'na': '„Å™', 'ni': '„Å´', 'nu': '„Å¨', 'ne': '„Å≠', 'no': '„ÅÆ',
            'nya': '„Å´„ÇÉ', 'nyu': '„Å´„ÇÖ', 'nyo': '„Å´„Çá',
            'n': '„Çì',
            
            // H
            'ha': '„ÅØ', 'hi': '„Å≤', 'fu': '„Åµ', 'hu': '„Åµ', 'he': '„Å∏', 'ho': '„Åª',
            'hya': '„Å≤„ÇÉ', 'hyu': '„Å≤„ÇÖ', 'hyo': '„Å≤„Çá',
            
            // B
            'ba': '„Å∞', 'bi': '„Å≥', 'bu': '„Å∂', 'be': '„Åπ', 'bo': '„Åº',
            'bya': '„Å≥„ÇÉ', 'byu': '„Å≥„ÇÖ', 'byo': '„Å≥„Çá',
            
            // P
            'pa': '„Å±', 'pi': '„Å¥', 'pu': '„Å∑', 'pe': '„Å∫', 'po': '„ÅΩ',
            'pya': '„Å¥„ÇÉ', 'pyu': '„Å¥„ÇÖ', 'pyo': '„Å¥„Çá',
            
            // M
            'ma': '„Åæ', 'mi': '„Åø', 'mu': '„ÇÄ', 'me': '„ÇÅ', 'mo': '„ÇÇ',
            'mya': '„Åø„ÇÉ', 'myu': '„Åø„ÇÖ', 'myo': '„Åø„Çá',
            
            // Y
            'ya': '„ÇÑ', 'yu': '„ÇÜ', 'yo': '„Çà',
            
            // R
            'ra': '„Çâ', 'ri': '„Çä', 'ru': '„Çã', 're': '„Çå', 'ro': '„Çç',
            'rya': '„Çä„ÇÉ', 'ryu': '„Çä„ÇÖ', 'ryo': '„Çä„Çá',
            
            // W
            'wa': '„Çè', 'wo': '„Çí', 'wi': '„Çê', 'we': '„Çë',
            
            // S√≠mbolos
            '-': '„Éº', ',': '„ÄÅ', '.': '„ÄÇ'
        };

        function convertRomajiToHiragana(input) {
            let result = '';
            let i = 0;
            
            while (i < input.length) {
                let matched = false;
                
                // Primero: Intentar convertir de 3 caracteres (para nya, kya, etc.)
                if (i + 2 < input.length) {
                    let threeChar = input.substring(i, i + 3).toLowerCase();
                    if (romajiToHiragana[threeChar]) {
                        result += romajiToHiragana[threeChar];
                        i += 3;
                        matched = true;
                        continue;
                    }
                }
                
                // Segundo: Manejar 'nn' espec√≠ficamente para „Çì
                if (i + 1 < input.length) {
                    let twoChar = input.substring(i, i + 2).toLowerCase();
                    
                    if (twoChar === 'nn') {
                        result += '„Çì';
                        i += 2;
                        matched = true;
                        continue;
                    }
                    
                    // Manejar consonantes dobles („Å£) - excepto 'nn'
                    if (input[i] === input[i + 1] && 
                        'kgsztdhbpmyrw'.includes(input[i].toLowerCase())) {
                        result += '„Å£';
                        i++;
                        matched = true;
                        continue;
                    }
                    
                    // Intentar convertir de 2 caracteres (na, ni, nu, ne, no, ka, ki, etc.)
                    if (romajiToHiragana[twoChar]) {
                        result += romajiToHiragana[twoChar];
                        i += 2;
                        matched = true;
                        continue;
                    }
                }
                
                // Tercero: Intentar convertir de 1 caracter (solo vocales: a, i, u, e, o)
                let oneChar = input[i].toLowerCase();
                
                // Solo convertir vocales individuales, NO la 'n'
                if ('aiueo'.includes(oneChar) && romajiToHiragana[oneChar]) {
                    result += romajiToHiragana[oneChar];
                    i++;
                    matched = true;
                    continue;
                }
                
                // Cuarto: Manejar 'n' especial
                if (oneChar === 'n') {
                    // Si es el √∫ltimo car√°cter, convertir a „Çì
                    if (i === input.length - 1) {
                        result += '„Çì';
                        i++;
                        matched = true;
                        continue;
                    }
                    
                    // Si est√° seguida de consonante (no vocal ni 'y'), convertir a „Çì
                    if (i + 1 < input.length) {
                        const nextChar = input[i + 1].toLowerCase();
                        if (!'aiueoy'.includes(nextChar)) {
                            result += '„Çì';
                            i++;
                            matched = true;
                            continue;
                        }
                    }
                }
                
                // Si no se pudo convertir, mantener el car√°cter original
                result += input[i];
                i++;
            }
            
            return result;
        }

        function bindRomajiConversion(inputElement) {
            if (!inputElement) return;
            
            let buffer = ''; // Buffer temporal para acumular caracteres
            
            inputElement.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                const inputValue = this.value;
                
                // Si el usuario borr√≥ texto, recalcular todo desde cero
                if (inputValue.length < buffer.length) {
                    buffer = inputValue;
                    return;
                }
                
                // Obtener solo los caracteres nuevos
                const newChars = inputValue.substring(buffer.length);
                buffer = inputValue;
                
                // Convertir
                const converted = convertRomajiToHiraganaWithBuffer(inputValue);
                
                if (inputValue !== converted) {
                    this.value = converted;
                    buffer = converted;
                    
                    // Ajustar cursor
                    const diff = inputValue.length - converted.length;
                    const newCursorPos = Math.max(0, cursorPos - diff);
                    this.setSelectionRange(newCursorPos, newCursorPos);
                }
            });
            
            inputElement.setAttribute('data-romaji-enabled', 'true');
        }

        function convertRomajiToHiraganaWithBuffer(input) {
            let result = '';
            let i = 0;
            
            while (i < input.length) {
                let matched = false;
                
                // 1. Intentar convertir de 3 caracteres (nya, kya, sha, etc.)
                if (i + 2 < input.length) {
                    let threeChar = input.substring(i, i + 3).toLowerCase();
                    if (romajiToHiragana[threeChar]) {
                        result += romajiToHiragana[threeChar];
                        i += 3;
                        continue;
                    }
                }
                
                // 2. Manejar 'nn' espec√≠ficamente para „Çì
                if (i + 1 < input.length) {
                    let twoChar = input.substring(i, i + 2).toLowerCase();
                    
                    if (twoChar === 'nn') {
                        result += '„Çì';
                        i += 2;
                        continue;
                    }
                    
                    // Manejar consonantes dobles („Å£)
                    if (input[i].toLowerCase() === input[i + 1].toLowerCase() && 
                        'kgsztdhbpmyrw'.includes(input[i].toLowerCase())) {
                        result += '„Å£';
                        i++;
                        continue;
                    }
                    
                    // 3. Intentar convertir de 2 caracteres (na, ni, nu, ka, shi, etc.)
                    if (romajiToHiragana[twoChar]) {
                        result += romajiToHiragana[twoChar];
                        i += 2;
                        continue;
                    }
                }
                
                // 4. Vocales individuales
                let oneChar = input[i].toLowerCase();
                if ('aiueo'.includes(oneChar) && romajiToHiragana[oneChar]) {
                    result += romajiToHiragana[oneChar];
                    i++;
                    continue;
                }
                
                // 5. Manejar 'n' especial - CLAVE: solo convertir si sabemos que debe ser „Çì
                if (oneChar === 'n') {
                    // Si es el √∫ltimo car√°cter Y no hay m√°s input, NO convertir a√∫n (dejar como 'n')
                    if (i === input.length - 1) {
                        // Dejar la 'n' sin convertir para que el usuario pueda seguir escribiendo
                        result += input[i];
                        i++;
                        continue;
                    }
                    
                    // Si est√° seguida de consonante (excepto 'y'), convertir a „Çì
                    if (i + 1 < input.length) {
                        const nextChar = input[i + 1].toLowerCase();
                        // Solo convertir si est√° seguida de consonante (no vocal ni 'y')
                        if (!'aiueoy'.includes(nextChar) && nextChar !== 'n') {
                            result += '„Çì';
                            i++;
                            continue;
                        }
                    }
                }
                
                // Si no se pudo convertir, mantener el car√°cter original
                result += input[i];
                i++;
            }
            
            return result;
        }

        // Sistema de traducciones
        const translations = {
            en: {
                app_title: 'üìö VocabMaster',
                app_subtitle: 'Your personal vocabulary learning system',
                tab_categories: 'üè∑Ô∏è Categories',
                tab_practice: 'üéØ Practice',
                tab_mistakes: '‚ùå My Mistakes',
                tab_stats: 'üìä Statistics',
                section_my_categories: 'üìÇ My Categories',
                section_configure_practice: 'üéØ Configure Practice',
                section_words_with_mistakes: '‚ùå Words with Mistakes',
                section_general_stats: 'üìä General Statistics',
                no_categories_available: 'No categories available',
                btn_start_practice: 'Start Practice',
                btn_select_all: 'Select All',
                btn_practice_mistakes: 'Practice Only Mistakes',
                btn_clear_mistakes: 'Clear Mistakes',
                stat_categories: 'Categories',
                stat_total_words: 'Total Words',
                stat_times_practiced: 'Times Practiced',
                modal_new_category: 'New Category',
                label_category_name: 'Category Name',
                placeholder_category_name: 'Ex: GENKI Lesson 9',
                btn_save: 'Save',
                btn_cancel: 'Cancel',
                btn_close: 'Close',
                modal_add_word: 'Add Word',
                label_word_term: 'Word/Term',
                placeholder_word: 'Ex: hot (weather)',
                label_translation: 'Translation (Hiragana/Katakana)',
                placeholder_translation: 'Ex: „ÅÇ„Å§„ÅÑ',
                label_kanji: 'Kanji (Optional)',
                placeholder_kanji: 'Ex: Êöë„ÅÑ',
                label_word_type: 'Word Type (Optional)',
                word_type_noun: 'Noun',
                word_type_verb: 'Verb',
                word_type_adjective: 'Adjective',
                word_type_adverb: 'Adverb',
                word_type_pronoun: 'Pronoun',
                word_type_particle: 'Particle',
                word_type_conjunction: 'Conjunction',
                word_type_interjection: 'Interjection',
                word_type_counter: 'Counter',
                word_type_expression: 'Expression',
                btn_add_word: '+ Add Word',
                btn_close: 'Close',
                no_mistakes_yet: 'No mistakes recorded yet!',
                practice_to_track: 'Practice to keep track of your mistakes.',
                words_count: 'words',
                btn_view: 'View',
                btn_delete: 'Delete',
                btn_practice: 'Practice',
                btn_new_category: 'New Category',
                table_category: 'Category',
                table_num_words: '# of Words',
                table_recent_attempts: 'Recent Attempts',
                table_actions: 'Actions',
                table_word: 'Word',
                table_translation: 'Translation',
                no_categories_message: 'No categories yet. Click "New Category" to create one.',
                confirm_delete_category: 'Are you sure you want to delete this category?',
                alert_category_name: 'Please enter a category name',
                alert_complete_fields: 'Please complete the required fields',
                no_words_in_category: 'No words in this category',
                alert_select_category: 'Please select at least one category',
                alert_no_words: 'Selected categories have no words',
                alert_no_mistakes: 'You have no mistakes to practice',
                question_label: 'Question',
                of_label: 'of',
                placeholder_answer: 'Write the translation...',
                btn_check: 'Check',
                btn_skip: 'Skip',
                btn_finish: 'Finish',
                feedback_correct: 'Correct! ‚ú®',
                feedback_incorrect: 'Incorrect. Answer:',
                feedback_or: 'or',
                stat_correct: 'Correct',
                stat_incorrect: 'Incorrect',
                stat_remaining: 'Remaining',
                results_title: 'Practice Completed! üéâ',
                results_correct_of: 'correct of',
                results_failed_words: 'Words Failed in this Session',
                btn_new_practice: 'New Practice',
                btn_back_to_categories: 'Back to Categories',
                confirm_end_practice: 'Are you sure you want to end the practice?',
                confirm_clear_mistakes: 'Are you sure you want to clear all mistakes?',
                no_mistakes_registered: 'No mistakes registered!',
                no_category: 'No category',
                section_category_history: 'üìà History by Category',
                history_last_practice: 'Last practice:',
                history_score: 'Score',
                history_correct_label: 'Correct',
                history_incorrect_label: 'Incorrect',
                history_skipped_label: 'Skipped',
                history_mistakes_title: 'Words Failed/Skipped:',
                no_practice_history: 'No practice history yet',
                practice_to_see_history: 'Complete a practice session to see your history here.',
                practice_mode_title: 'Practice Mode',
                practice_mode_en_ja: 'EN ‚Üí JP',
                practice_mode_ja_en: 'JP ‚Üí EN',
                practice_mode_mixed: 'Mixed',
                select_categories_title: 'Select Categories',
                history_table_date: 'Date',
                history_table_correct: 'Correct',
                history_table_incorrect: 'Incorrect',
                history_table_skipped: 'Skipped',
                history_table_accuracy: 'Accuracy',
                history_table_actions: 'Actions',
                btn_view_mistakes: 'View Mistakes'
            },
            ja: {
                app_title: 'üìö VocabMaster',
                app_subtitle: '„ÅÇ„Å™„ÅüÂ∞ÇÁî®„ÅÆË™ûÂΩôÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†',
                tab_categories: 'üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™„Éº',
                tab_practice: 'üéØ Á∑¥Áøí',
                tab_mistakes: '‚ùå ÈñìÈÅï„ÅÑ',
                tab_stats: 'üìä Áµ±Ë®à',
                section_my_categories: 'üìÇ „Éû„Ç§„Ç´„ÉÜ„Ç¥„É™„Éº',
                section_configure_practice: 'üéØ Á∑¥Áøí„ÇíË®≠ÂÆö',
                section_words_with_mistakes: '‚ùå ÈñìÈÅï„Åà„ÅüÂçòË™û',
                section_general_stats: 'üìä ÂÖ®‰ΩìÁµ±Ë®à',
                no_categories_available: '„Ç´„ÉÜ„Ç¥„É™„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                btn_start_practice: 'Á∑¥Áøí„ÇíÈñãÂßã',
                btn_select_all: '„Åô„Åπ„Å¶ÈÅ∏Êäû',
                btn_practice_mistakes: 'ÈñìÈÅï„ÅÑ„Å†„ÅëÁ∑¥Áøí',
                btn_clear_mistakes: 'ÈñìÈÅï„ÅÑ„Çí„ÇØ„É™„Ç¢',
                stat_categories: '„Ç´„ÉÜ„Ç¥„É™„Éº',
                stat_total_words: 'Á∑èÂçòË™ûÊï∞',
                stat_times_practiced: 'Á∑¥ÁøíÂõûÊï∞',
                modal_new_category: 'Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„Éº',
                label_category_name: '„Ç´„ÉÜ„Ç¥„É™„ÉºÂêç',
                placeholder_category_name: '‰æãÔºöGENKI Á¨¨9Ë™≤',
                btn_save: '‰øùÂ≠ò',
                btn_cancel: '„Ç≠„É£„É≥„Çª„É´',
                btn_close: 'Èñâ„Åò„Çã',
                modal_add_word: 'ÂçòË™û„ÇíËøΩÂä†',
                label_word_term: 'ÂçòË™û„ÉªÁî®Ë™û',
                placeholder_word: '‰æãÔºöhot (weather)',
                label_translation: 'ÁøªË®≥Ôºà„Å≤„Çâ„Åå„Å™„Éª„Ç´„Çø„Ç´„ÉäÔºâ',
                placeholder_translation: '‰æãÔºö„ÅÇ„Å§„ÅÑ',
                label_kanji: 'Êº¢Â≠óÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ',
                placeholder_kanji: '‰æãÔºöÊöë„ÅÑ',
                label_word_type: 'ÂìÅË©ûÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ',
                word_type_noun: 'ÂêçË©û',
                word_type_verb: 'ÂãïË©û',
                word_type_adjective: 'ÂΩ¢ÂÆπË©û',
                word_type_adverb: 'ÂâØË©û',
                word_type_pronoun: '‰ª£ÂêçË©û',
                word_type_particle: 'Âä©Ë©û',
                word_type_conjunction: 'Êé•Á∂öË©û',
                word_type_interjection: 'ÊÑüÂãïË©û',
                word_type_counter: 'Âä©Êï∞Ë©û',
                word_type_expression: 'Ë°®Áèæ',
                btn_add_word: '+ ÂçòË™û„ÇíËøΩÂä†',
                btn_close: 'Èñâ„Åò„Çã',
                no_mistakes_yet: '„Åæ„Å†ÈñìÈÅï„ÅÑ„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ',
                practice_to_track: 'Á∑¥Áøí„Åó„Å¶ÈñìÈÅï„ÅÑ„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                words_count: 'ÂçòË™û',
                btn_view: 'Ë°®Á§∫',
                btn_delete: 'ÂâäÈô§',
                btn_practice: 'Á∑¥Áøí',
                btn_new_category: 'Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™„Éº',
                table_category: '„Ç´„ÉÜ„Ç¥„É™„Éº',
                table_num_words: 'ÂçòË™ûÊï∞',
                table_recent_attempts: 'ÊúÄËøë„ÅÆË©¶Ë°å',
                table_actions: 'Êìç‰Ωú',
                table_word: 'ÂçòË™û',
                table_translation: 'ÁøªË®≥',
                no_categories_message: '„Ç´„ÉÜ„Ç¥„É™„Éº„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåÊñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™„Éº„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                confirm_delete_category: '„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
                alert_category_name: '„Ç´„ÉÜ„Ç¥„É™„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                alert_complete_fields: 'ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                no_words_in_category: '„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„Å´„ÅØÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                alert_select_category: 'Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                alert_no_words: 'ÈÅ∏Êäû„Åó„Åü„Ç´„ÉÜ„Ç¥„É™„Éº„Å´„ÅØÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                alert_no_mistakes: 'Á∑¥Áøí„Åô„ÇãÈñìÈÅï„ÅÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                question_label: 'ÂïèÈ°å',
                of_label: '/',
                placeholder_answer: 'ÁøªË®≥„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ...',
                btn_check: 'Á¢∫Ë™ç',
                btn_skip: '„Çπ„Ç≠„ÉÉ„Éó',
                btn_finish: 'ÁµÇ‰∫Ü',
                feedback_correct: 'Ê≠£Ëß£ÔºÅ ‚ú®',
                feedback_incorrect: '‰∏çÊ≠£Ëß£„ÄÇÁ≠î„ÅàÔºö',
                feedback_or: '„Åæ„Åü„ÅØ',
                stat_correct: 'Ê≠£Ëß£',
                stat_incorrect: '‰∏çÊ≠£Ëß£',
                stat_remaining: 'ÊÆã„Çä',
                results_title: 'Á∑¥ÁøíÂÆå‰∫ÜÔºÅ üéâ',
                results_correct_of: 'Ê≠£Ëß£',
                results_failed_words: '„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅßÈñìÈÅï„Åà„ÅüÂçòË™û',
                btn_new_practice: 'Êñ∞„Åó„ÅÑÁ∑¥Áøí',
                btn_back_to_categories: '„Ç´„ÉÜ„Ç¥„É™„Éº„Å´Êàª„Çã',
                confirm_end_practice: 'Á∑¥Áøí„ÇíÁµÇ‰∫Ü„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
                confirm_clear_mistakes: '„Åô„Åπ„Å¶„ÅÆÈñìÈÅï„ÅÑ„Çí„ÇØ„É™„Ç¢„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
                no_mistakes_registered: 'ÈñìÈÅï„ÅÑ„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ',
                no_category: '„Ç´„ÉÜ„Ç¥„É™„Éº„Å™„Åó',
                section_category_history: 'üìà „Ç´„ÉÜ„Ç¥„É™„ÉºÂà•Â±•Ê≠¥',
                history_last_practice: 'ÊúÄÁµÇÁ∑¥ÁøíÔºö',
                history_score: '„Çπ„Ç≥„Ç¢',
                history_correct_label: 'Ê≠£Ëß£',
                history_incorrect_label: '‰∏çÊ≠£Ëß£',
                history_skipped_label: '„Çπ„Ç≠„ÉÉ„Éó',
                history_mistakes_title: 'ÈñìÈÅï„Åà„Åü„Éª„Çπ„Ç≠„ÉÉ„Éó„Åó„ÅüÂçòË™ûÔºö',
                no_practice_history: 'Á∑¥ÁøíÂ±•Ê≠¥„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì',
                practice_to_see_history: 'Á∑¥Áøí„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂÆå‰∫Ü„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ',
                practice_mode_title: 'Á∑¥Áøí„É¢„Éº„Éâ',
                practice_mode_en_ja: 'Ëã±‚ÜíÊó•',
                practice_mode_ja_en: 'Êó•‚ÜíËã±',
                practice_mode_mixed: '„Éü„ÉÉ„ÇØ„Çπ',
                select_categories_title: '„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÈÅ∏Êäû',
                history_table_date: 'Êó•‰ªò',
                history_table_correct: 'Ê≠£Ëß£',
                history_table_incorrect: '‰∏çÊ≠£Ëß£',
                history_table_skipped: '„Çπ„Ç≠„ÉÉ„Éó',
                history_table_accuracy: 'Ê≠£Ëß£Áéá',
                history_table_actions: 'Êìç‰Ωú',
                btn_view_mistakes: 'ÈñìÈÅï„ÅÑ„ÇíË°®Á§∫'
            }
        };

        let currentLanguage = localStorage.getItem('vocabmaster_language') || 'en';

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('vocabmaster_language', lang);
            
            // Actualizar botones de idioma
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lang-' + lang).classList.add('active');
            
            // Traducir textos
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Traducir placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Actualizar contenido din√°mico
            renderCategories();
            renderCategoryCheckboxes();
            renderMistakes();
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // Datos
        let categories = JSON.parse(localStorage.getItem('vocabmaster_categories')) || [];
        let mistakes = JSON.parse(localStorage.getItem('vocabmaster_mistakes')) || [];
        let stats = JSON.parse(localStorage.getItem('vocabmaster_stats')) || {
            totalPracticed: 0
        };
        let categoryHistory = JSON.parse(localStorage.getItem('vocabmaster_category_history')) || {};

        // Debug: Mostrar lo que se carg√≥
        console.log('üìä VocabMaster initialized');
        console.log('Categories loaded:', categories.length);
        console.log('Mistakes loaded:', mistakes.length);
        console.log('localStorage available:', typeof(Storage) !== 'undefined');

        let currentCategoryId = null;
        let practiceMode = 'normal'; // 'normal' o 'mistakes'
        let practiceDirection = 'en-ja'; // 'en-ja', 'ja-en', o 'mixed'
        let currentPracticeWords = [];
        let currentWordIndex = 0;
        let practiceStats = { correct: 0, incorrect: 0, skipped: 0 };
        let currentSessionMistakes = [];
        let currentPracticeCategories = []; // Para rastrear qu√© categor√≠as est√°n en la pr√°ctica actual
        // TODO: CONFIGURACI√ìN DE FIREBASE
// Reemplaza esto con tu configuraci√≥n de Firebase del Paso 2
const firebaseConfig = {
  apiKey: "AIzaSyCzEe2mrUAACxpKoGCm1pZT_Qpzb_QI7LII",
  authDomain: "vocabmaster-4eb91.firebaseapp.com",
  projectId: "vocabmaster-4eb91,
  storageBucket: "vocabmaster-4eb91.firebasestorage.app",
  messagingSenderId: "943637387839",
  appId: "1:943637387839:web:7620e761b27ad7f746768a"
};



        // Inicializaci√≥n
        function init() {
            changeLanguage(currentLanguage);
            renderCategories();
            renderCategoryCheckboxes();
            renderMistakes();
            updateStats();
            renderCategoryHistory();
            
            // Activar conversi√≥n autom√°tica de romaji a hiragana en inputs de traducci√≥n
            const translationInput = document.getElementById('translation-input');
            const kanjiInput = document.getElementById('kanji-input');
            
            if (translationInput) {
                bindRomajiConversion(translationInput);
            }
            if (kanjiInput) {
                bindRomajiConversion(kanjiInput);
            }
        }

        // TABS
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
            
            if (tabName === 'mistakes') {
                renderMistakes();
            } else if (tabName === 'stats') {
                renderCategoryHistory();
            }
        }

        // CATEGOR√çAS
        function renderCategories() {
            const container = document.getElementById('categories-container');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-categories">
                        <div class="empty-icon">üìÇ</div>
                        <p>${t('no_categories_message')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="categories-table">
                    <thead>
                        <tr>
                            <th data-i18n="table_category">${t('table_category')}</th>
                            <th data-i18n="table_num_words">${t('table_num_words')}</th>
                            <th style="text-align: center;" data-i18n="table_recent_attempts">${t('table_recent_attempts')}</th>
                            <th data-i18n="table_actions">${t('table_actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${categories.map(cat => {
                            const recentAttempts = getRecentAttempts(cat.id, 3);
                            return `
                            <tr data-category-id="${cat.id}">
                                <td class="category-name-cell">${cat.name}</td>
                                <td class="category-words-count">${cat.words.length}</td>
                                <td class="recent-attempts-cell">
                                    ${recentAttempts.length > 0 ? `
                                        <div class="attempt-badges">
                                            ${recentAttempts.map(attempt => {
                                                let badgeClass = 'poor';
                                                if (attempt.percentage >= 80) badgeClass = 'excellent';
                                                else if (attempt.percentage >= 60) badgeClass = 'good';
                                                return `<span class="attempt-badge ${badgeClass}">${attempt.percentage}%</span>`;
                                            }).join('')}
                                        </div>
                                    ` : `<span class="no-attempts">-</span>`}
                                </td>
                                <td class="category-actions-cell">
                                    <button class="btn-small btn-practice-category" data-id="${cat.id}">${t('btn_practice')}</button>
                                    <button class="btn-small btn-view-category" data-id="${cat.id}">${t('btn_view')}</button>
                                    <button class="btn-small btn-delete-category" data-id="${cat.id}">${t('btn_delete')}</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            // A√±adir event listeners a las filas
            document.querySelectorAll('.categories-table tbody tr').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Solo si no es un bot√≥n
                    if (!e.target.closest('button')) {
                        const catId = this.getAttribute('data-category-id');
                        viewCategory(catId);
                    }
                });
            });

            // Event listeners para botones de pr√°ctica
            document.querySelectorAll('.btn-practice-category').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    practiceSingleCategory(id);
                });
            });

            // Event listeners para botones de ver
            document.querySelectorAll('.btn-view-category').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    viewCategory(id);
                });
            });

            // Event listeners para botones de eliminar
            document.querySelectorAll('.btn-delete-category').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    
                    if (confirm(t('confirm_delete_category'))) {
                        categories = categories.filter(c => c.id !== id);
                        saveData();
                        renderCategories();
                        renderCategoryCheckboxes();
                        updateStats();
                    }
                });
            });
        }

        function openAddCategoryModal() {
            const input = document.getElementById('category-name-input');
            input.value = '';
            document.getElementById('add-category-modal').classList.add('active');
            
            // Focus autom√°tico
            setTimeout(() => {
                input.focus();
            }, 100);
            
            // Permitir guardar con Enter
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveCategory();
                }
            };
        }

        function saveCategory() {
            const name = document.getElementById('category-name-input').value.trim();
            
            console.log('saveCategory called with name:', name);
            
            if (!name) {
                alert(t('alert_category_name'));
                return;
            }

            const category = {
                id: Date.now().toString(),
                name: name,
                words: []
            };

            console.log('Creating category:', category);
            categories.push(category);
            console.log('Categories array now:', categories);
            
            saveData();
            console.log('Data saved to localStorage');
            
            // Limpiar el input
            document.getElementById('category-name-input').value = '';
            
            // Cerrar el modal
            closeModal('add-category-modal');
            
            // Actualizar todas las vistas
            renderCategories();
            renderCategoryCheckboxes();
            updateStats();
            
            console.log('All views updated');
        }

        function deleteCategory(id) {
            if (!confirm(t('confirm_delete_category'))) return;
            
            categories = categories.filter(c => c.id !== id);
            saveData();
            renderCategories();
            renderCategoryCheckboxes();
            updateStats();
        }

        // Funci√≥n auxiliar para obtener los √∫ltimos N intentos de una categor√≠a
        function getRecentAttempts(categoryId, limit = 3) {
            // Buscar todas las claves que empiecen con este categoryId
            const attempts = Object.values(categoryHistory)
                .filter(entry => entry.categoryId === categoryId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, limit);
            
            return attempts;
        }

        function viewCategory(id) {
            currentCategoryId = id;
            const category = categories.find(c => c.id === id);
            if (!category) return;

            document.getElementById('modal-category-title').textContent = category.name;
            renderCategoryWords(category);
            document.getElementById('view-category-modal').classList.add('active');
        }

        function renderCategoryWords(category) {
            const list = document.getElementById('category-words-list');
            
            if (category.words.length === 0) {
                list.innerHTML = `<div class="empty-state"><p>${t('no_words_in_category')}</p></div>`;
                return;
            }

            list.innerHTML = `
                <table class="words-table">
                    <thead>
                        <tr>
                            <th>${t('table_word')}</th>
                            <th>${t('table_translation')}</th>
                            <th>${t('table_actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${category.words.map((word, index) => `
                            <tr>
                                <td class="word-cell">
                                    ${word.word}
                                    ${word.type ? `<span class="word-type-badge word-type-${word.type}">${t('word_type_' + word.type)}</span>` : ''}
                                </td>
                                <td class="translation-cell">
                                    ${word.translation}
                                    ${word.kanji ? `<br><span class="kanji-text">${word.kanji}</span>` : ''}
                                </td>
                                <td class="actions-cell">
                                    <button class="btn-delete-word" data-category-id="${category.id}" data-word-index="${index}">
                                        ${t('btn_delete')}
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // A√±adir event listeners a los botones de eliminar palabra
            document.querySelectorAll('.btn-delete-word').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category-id');
                    const wordIndex = parseInt(this.getAttribute('data-word-index'));
                    
                    const cat = categories.find(c => c.id === categoryId);
                    if (!cat) return;

                    cat.words.splice(wordIndex, 1);
                    saveData();
                    renderCategoryWords(cat);
                    updateStats();
                });
            });
        }

        // PALABRAS
        function openAddWordModal() {
            if (!currentCategoryId) return;
            
            document.getElementById('word-input').value = '';
            document.getElementById('translation-input').value = '';
            document.getElementById('kanji-input').value = '';
            closeModal('view-category-modal');
            document.getElementById('add-word-modal').classList.add('active');
        }

        function saveWord() {
            const word = document.getElementById('word-input').value.trim();
            const translation = document.getElementById('translation-input').value.trim();
            const kanji = document.getElementById('kanji-input').value.trim();
            const wordType = document.getElementById('word-type-select').value;

            if (!word || !translation) {
                alert(t('alert_complete_fields'));
                return;
            }

            const category = categories.find(c => c.id === currentCategoryId);
            if (!category) return;

            category.words.push({ 
                word, 
                translation,
                kanji: kanji || null,
                type: wordType || null
            });
            saveData();
            closeModal('add-word-modal');
            viewCategory(currentCategoryId);
            updateStats();
            
            // Limpiar el formulario
            document.getElementById('word-input').value = '';
            document.getElementById('translation-input').value = '';
            document.getElementById('kanji-input').value = '';
            document.getElementById('word-type-select').value = '';
        }

        function deleteWord(categoryId, wordIndex) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            category.words.splice(wordIndex, 1);
            saveData();
            renderCategoryWords(category);
            updateStats();
        }

        // PR√ÅCTICA
        function renderCategoryCheckboxes() {
            const container = document.getElementById('category-checkboxes');
            
            if (categories.length === 0) {
                container.innerHTML = `<p style="color: var(--text-light); text-align: center;">${t('no_categories_available')}</p>`;
                return;
            }

            container.innerHTML = categories.map(cat => `
                <div class="checkbox-item">
                    <input type="checkbox" id="cat-${cat.id}" value="${cat.id}">
                    <label for="cat-${cat.id}">${cat.name} (${cat.words.length} ${t('words_count')})</label>
                </div>
            `).join('');
        }

        function selectAllCategories() {
            document.querySelectorAll('#category-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function startPractice() {
            const selectedCats = Array.from(document.querySelectorAll('#category-checkboxes input:checked'))
                .map(cb => cb.value);

            if (selectedCats.length === 0) {
                alert(t('alert_select_category'));
                return;
            }

            // Capturar el modo de pr√°ctica seleccionado
            const selectedMode = document.querySelector('input[name="practice-mode"]:checked')?.value || 'en-ja';
            practiceDirection = selectedMode;

            currentPracticeWords = [];
            currentPracticeCategories = selectedCats;
            
            selectedCats.forEach(catId => {
                const cat = categories.find(c => c.id === catId);
                if (cat) {
                    cat.words.forEach(word => {
                        // Para modo mixto, a√±adir ambas direcciones
                        if (selectedMode === 'mixed') {
                            // Direcci√≥n EN -> JA
                            currentPracticeWords.push({
                                ...word,
                                categoryId: catId,
                                categoryName: cat.name,
                                direction: 'en-ja'
                            });
                            // Direcci√≥n JA -> EN
                            currentPracticeWords.push({
                                ...word,
                                categoryId: catId,
                                categoryName: cat.name,
                                direction: 'ja-en'
                            });
                        } else {
                            // Direcci√≥n √∫nica
                            currentPracticeWords.push({
                                ...word,
                                categoryId: catId,
                                categoryName: cat.name,
                                direction: selectedMode
                            });
                        }
                    });
                }
            });

            if (currentPracticeWords.length === 0) {
                alert(t('alert_no_words'));
                return;
            }

            shuffleArray(currentPracticeWords);
            practiceMode = 'normal';
            currentWordIndex = 0;
            practiceStats = { correct: 0, incorrect: 0, skipped: 0 };
            currentSessionMistakes = [];

            document.getElementById('practice-setup').style.display = 'none';
            document.getElementById('practice-quiz').style.display = 'block';
            
            showPracticeQuestion();
        }

        function practiceMistakes() {
            if (mistakes.length === 0) {
                alert(t('alert_no_mistakes'));
                return;
            }

            currentPracticeWords = [...mistakes];
            shuffleArray(currentPracticeWords);
            practiceMode = 'mistakes';
            currentWordIndex = 0;
            practiceStats = { correct: 0, incorrect: 0, skipped: 0 };
            currentSessionMistakes = [];

            showTab('practice');
            document.getElementById('practice-setup').style.display = 'none';
            document.getElementById('practice-quiz').style.display = 'block';
            
            showPracticeQuestion();
        }

        function practiceSingleCategory(categoryId) {
            const cat = categories.find(c => c.id === categoryId);
            if (!cat) return;

            if (cat.words.length === 0) {
                alert(t('alert_no_words'));
                return;
            }

            currentPracticeWords = cat.words.map(word => ({
                ...word,
                categoryId: cat.id,
                categoryName: cat.name
            }));
            
            currentPracticeCategories = [categoryId];
            shuffleArray(currentPracticeWords);
            practiceMode = 'normal';
            currentWordIndex = 0;
            practiceStats = { correct: 0, incorrect: 0, skipped: 0 };
            currentSessionMistakes = [];

            // Cambiar a la pesta√±a de pr√°ctica
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.tab[onclick*="practice"]').classList.add('active');
            document.getElementById('practice-content').classList.add('active');
            
            document.getElementById('practice-setup').style.display = 'none';
            document.getElementById('practice-quiz').style.display = 'block';
            
            showPracticeQuestion();
        }

        function showPracticeQuestion() {
            const word = currentPracticeWords[currentWordIndex];
            const direction = word.direction || 'en-ja';
            
            // Determinar qu√© mostrar como pregunta y qu√© esperar como respuesta
            const question = direction === 'en-ja' ? word.word : (word.kanji || word.translation);
            const isJapaneseInput = direction === 'en-ja';
            
            document.getElementById('practice-quiz').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${practiceStats.correct}</div>
                        <div class="stat-label">${t('stat_correct')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${practiceStats.incorrect}</div>
                        <div class="stat-label">${t('stat_incorrect')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${currentPracticeWords.length - currentWordIndex}</div>
                        <div class="stat-label">${t('stat_remaining')}</div>
                    </div>
                </div>

                <div class="quiz-card">
                    <div class="question-counter">${t('question_label')} ${currentWordIndex + 1} ${t('of_label')} ${currentPracticeWords.length}</div>
                    <div class="question" style="font-family: ${direction === 'ja-en' ? "'Noto Sans JP', sans-serif" : "'Lexend', sans-serif"};">${question}</div>
                    ${isJapaneseInput ? `
                        <div class="input-wrapper-jp">
                            <span class="ime-indicator">üáØüáµ „ÅÇ Hiragana</span>
                            <input type="text" class="answer-input" id="practice-answer" placeholder="${t('placeholder_answer')}" autofocus>
                        </div>
                    ` : `
                        <input type="text" class="answer-input" id="practice-answer" style="font-family: 'Outfit', sans-serif;" placeholder="Write in English..." autofocus>
                    `}
                    <div class="feedback" id="practice-feedback"></div>
                </div>

                <div class="btn-group" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="checkPracticeAnswer()">${t('btn_check')}</button>
                    <button class="btn btn-secondary" onclick="skipPracticeWord()">${t('btn_skip')}</button>
                    <button class="btn btn-secondary" onclick="endPractice()">${t('btn_finish')}</button>
                </div>
            `;

            // Activar conversi√≥n de romaji a hiragana solo si el input es japon√©s
            const answerInput = document.getElementById('practice-answer');
            if (isJapaneseInput) {
                bindRomajiConversion(answerInput);
            }
            
            // Hacer focus autom√°tico en el input
            setTimeout(() => {
                answerInput.focus();
            }, 50);
            
            answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPracticeAnswer();
                }
            });
        }

        function checkPracticeAnswer() {
            const input = document.getElementById('practice-answer');
            const userAnswer = input.value.trim();
            const word = currentPracticeWords[currentWordIndex];
            const direction = word.direction || 'en-ja';
            const feedback = document.getElementById('practice-feedback');

            if (!userAnswer) {
                return;
            }

            let isCorrect = false;
            let correctAnswerText = '';

            // Validar seg√∫n la direcci√≥n
            if (direction === 'en-ja') {
                // Ingl√©s -> Japon√©s: Aceptar hiragana/katakana o kanji
                const normalizedAnswer = normalize(userAnswer);
                const normalizedTranslation = normalize(word.translation);
                const normalizedKanji = word.kanji ? normalize(word.kanji) : null;
                
                isCorrect = normalizedAnswer === normalizedTranslation || 
                           (normalizedKanji && normalizedAnswer === normalizedKanji);
                
                correctAnswerText = word.translation;
                if (word.kanji) {
                    correctAnswerText += ` ${t('feedback_or')} ${word.kanji}`;
                }
            } else {
                // Japon√©s -> Ingl√©s: Validar respuesta en ingl√©s
                const normalizedAnswer = normalize(userAnswer);
                const normalizedWord = normalize(word.word);
                
                isCorrect = normalizedAnswer === normalizedWord;
                correctAnswerText = word.word;
            }

            if (isCorrect) {
                input.classList.add('correct');
                feedback.textContent = t('feedback_correct');
                feedback.className = 'feedback show correct';
                practiceStats.correct++;

                // Remover de errores si estaba
                mistakes = mistakes.filter(m => 
                    !(m.word === word.word && m.translation === word.translation)
                );
            } else {
                input.classList.add('incorrect');
                feedback.textContent = `${t('feedback_incorrect')} ${correctAnswerText}`;
                feedback.className = 'feedback show incorrect';
                practiceStats.incorrect++;

                // A√±adir a errores
                const mistakeExists = mistakes.some(m => 
                    m.word === word.word && m.translation === word.translation
                );
                if (!mistakeExists) {
                    mistakes.push({
                        word: word.word,
                        translation: word.translation,
                        kanji: word.kanji,
                        categoryName: word.categoryName
                    });
                }
                
                currentSessionMistakes.push(word);
            }

            stats.totalPracticed++;
            saveData();
            input.disabled = true;

            // Variable para controlar si ya avanz√≥
            let hasAdvanced = false;
            let canAdvanceWithEnter = false;

            // Funci√≥n para avanzar a la siguiente pregunta
            const advanceToNext = () => {
                if (hasAdvanced) return;
                hasAdvanced = true;
                
                currentWordIndex++;
                if (currentWordIndex < currentPracticeWords.length) {
                    showPracticeQuestion();
                } else {
                    showPracticeResults();
                }
            };

            // Listener temporal para Enter
            const enterListener = (e) => {
                if (e.key === 'Enter' && canAdvanceWithEnter) {
                    advanceToNext();
                    document.removeEventListener('keypress', enterListener);
                }
            };
            document.addEventListener('keypress', enterListener);

            // Permitir avanzar con Enter despu√©s de 400ms (tiempo m√≠nimo para ver el feedback)
            setTimeout(() => {
                canAdvanceWithEnter = true;
            }, 400);

            // Auto-avanzar despu√©s de 1 segundo
            setTimeout(() => {
                document.removeEventListener('keypress', enterListener);
                advanceToNext();
            }, 1000);
        }

        function skipPracticeWord() {
            const word = currentPracticeWords[currentWordIndex];
            practiceStats.incorrect++;
            practiceStats.skipped++;

            const mistakeExists = mistakes.some(m => 
                m.word === word.word && m.translation === word.translation
            );
            if (!mistakeExists) {
                mistakes.push({
                    word: word.word,
                    translation: word.translation,
                    kanji: word.kanji,
                    categoryName: word.categoryName,
                    skipped: true
                });
            }

            currentSessionMistakes.push({...word, skipped: true});
            saveData();

            currentWordIndex++;
            if (currentWordIndex < currentPracticeWords.length) {
                showPracticeQuestion();
            } else {
                showPracticeResults();
            }
        }

        function showPracticeResults() {
            const total = currentPracticeWords.length;
            const percentage = Math.round((practiceStats.correct / total) * 100);

            // Guardar historial por categor√≠a
            saveCategoryHistory();

            let html = `
                <div class="results-screen">
                    <div class="results-title">${t('results_title')}</div>
                    <div class="results-percentage">${percentage}%</div>
                    <p style="font-size: 1.3em; margin: 20px 0;">${practiceStats.correct} ${t('results_correct_of')} ${total}</p>
            `;

            if (currentSessionMistakes.length > 0) {
                html += `
                    <div class="failed-words">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">${t('results_failed_words')}</h3>
                        ${currentSessionMistakes.map(word => `
                            <div class="failed-word-item">
                                <div><strong>${word.word}</strong> ${word.skipped ? '<span style="color: #FFA500;">(Skipped)</span>' : ''}</div>
                                <div style="color: var(--text-light); font-family: 'Noto Sans JP', sans-serif;">
                                    ${word.translation}
                                    ${word.kanji ? `<br><span style="font-weight: 600; color: var(--primary);">${word.kanji}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += `
                    <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="restartPracticeSetup()">${t('btn_new_practice')}</button>
                        <button class="btn btn-secondary" onclick="showTab('categories')">${t('btn_back_to_categories')}</button>
                    </div>
                </div>
            `;

            document.getElementById('practice-quiz').innerHTML = html;
        }

        function saveCategoryHistory() {
            const timestamp = new Date().toISOString();
            
            // Agrupar palabras por categor√≠a
            const categoriesInSession = {};
            currentPracticeWords.forEach(word => {
                if (!categoriesInSession[word.categoryId]) {
                    categoriesInSession[word.categoryId] = {
                        categoryName: word.categoryName,
                        words: []
                    };
                }
                categoriesInSession[word.categoryId].words.push(word);
            });

            // Guardar historial para cada categor√≠a
            Object.keys(categoriesInSession).forEach(catId => {
                const catWords = categoriesInSession[catId].words;
                const catMistakes = currentSessionMistakes.filter(m => m.categoryId === catId);
                const catCorrect = catWords.length - catMistakes.length;
                const catSkipped = catMistakes.filter(m => m.skipped).length;
                const catIncorrect = catMistakes.length - catSkipped;

                // Crear una clave √∫nica para este intento: categoryId + timestamp
                const attemptKey = `${catId}_${Date.now()}`;

                categoryHistory[attemptKey] = {
                    categoryId: catId,
                    categoryName: categoriesInSession[catId].categoryName,
                    date: timestamp,
                    total: catWords.length,
                    correct: catCorrect,
                    incorrect: catIncorrect,
                    skipped: catSkipped,
                    percentage: Math.round((catCorrect / catWords.length) * 100),
                    mistakes: catMistakes.map(m => ({
                        word: m.word,
                        translation: m.translation,
                        kanji: m.kanji,
                        skipped: m.skipped || false
                    }))
                };
            });

            localStorage.setItem('vocabmaster_category_history', JSON.stringify(categoryHistory));
            
            // Actualizar TODAS las vistas
            renderCategoryHistory();
            renderCategories();
        }

        function endPractice() {
            if (confirm(t('confirm_end_practice'))) {
                showPracticeResults();
            }
        }

        function restartPracticeSetup() {
            document.getElementById('practice-setup').style.display = 'block';
            document.getElementById('practice-quiz').style.display = 'none';
        }

        // ERRORES
        function renderMistakes() {
            const container = document.getElementById('mistakes-list');
            const btn = document.getElementById('practice-mistakes-btn');

            if (mistakes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ú®</div>
                        <p>${t('no_mistakes_registered')}</p>
                    </div>
                `;
                btn.style.display = 'none';
                return;
            }

            container.innerHTML = `
                <div class="words-list">
                    ${mistakes.map(m => `
                        <div class="word-item">
                            <div>
                                <div class="word-text">${m.word}</div>
                                <div style="font-size: 0.85em; color: var(--text-light); margin-top: 5px;">
                                    ${m.categoryName || t('no_category')}
                                </div>
                            </div>
                            <div class="translation-text" style="font-family: 'Noto Sans JP', sans-serif;">
                                ${m.translation}
                                ${m.kanji ? `<br><span style="font-weight: 600; color: var(--primary);">${m.kanji}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            btn.style.display = 'inline-block';
        }

        function clearMistakes() {
            if (confirm(t('confirm_clear_mistakes'))) {
                mistakes = [];
                saveData();
                renderMistakes();
            }
        }

        // HISTORIAL DE CATEGOR√çAS
        function renderCategoryHistory() {
            const container = document.getElementById('category-history-container');
            
            const allAttempts = Object.values(categoryHistory);
            
            if (allAttempts.length === 0) {
                container.innerHTML = `
                    <div class="no-history">
                        <div class="no-history-icon">üìä</div>
                        <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">${t('no_practice_history')}</p>
                        <p>${t('practice_to_see_history')}</p>
                    </div>
                `;
                return;
            }

            // Ordenar por fecha (m√°s reciente primero)
            allAttempts.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>${t('table_category')}</th>
                            <th>${t('history_table_date')}</th>
                            <th style="text-align: center;">${t('history_table_correct')}</th>
                            <th style="text-align: center;">${t('history_table_incorrect')}</th>
                            <th style="text-align: center;">${t('history_table_skipped')}</th>
                            <th style="text-align: center;">${t('history_table_accuracy')}</th>
                            <th style="text-align: center;">${t('history_table_actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allAttempts.map((entry, index) => {
                            const date = new Date(entry.date);
                            const formattedDate = date.toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            // Encontrar la clave de este intento en el objeto
                            const attemptKey = Object.keys(categoryHistory).find(key => categoryHistory[key] === entry);

                            return `
                                <tr>
                                    <td class="category-cell">${entry.categoryName}</td>
                                    <td class="date-cell">${formattedDate}</td>
                                    <td class="stat-cell correct">${entry.correct}</td>
                                    <td class="stat-cell incorrect">${entry.incorrect}</td>
                                    <td class="stat-cell skipped">${entry.skipped}</td>
                                    <td class="accuracy-cell">${entry.percentage}%</td>
                                    <td class="actions-cell">
                                        ${entry.mistakes && entry.mistakes.length > 0 ? 
                                            `<button class="btn-view-mistakes" onclick="showMistakesModal('${attemptKey}')">${t('btn_view_mistakes')}</button>` 
                                            : '<span style="color: var(--text-light); font-size: 0.85em;">-</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMistakesModal(attemptKey) {
            const entry = categoryHistory[attemptKey];
            if (!entry || !entry.mistakes || entry.mistakes.length === 0) return;

            const modal = document.createElement('div');
            modal.className = 'mistakes-modal-overlay show';
            modal.innerHTML = `
                <div class="mistakes-modal-content">
                    <h3 class="mistakes-modal-title">${entry.categoryName} - ${t('btn_view_mistakes')}</h3>
                    <div class="mistakes-list">
                        ${entry.mistakes.map(mistake => `
                            <div class="mistake-item">
                                <div class="mistake-word">
                                    ${mistake.word}
                                    ${mistake.skipped ? '<span class="mistake-skipped-badge">SKIPPED</span>' : ''}
                                </div>
                                <div class="mistake-translation">
                                    ${mistake.translation}
                                    ${mistake.kanji ? ` / ${mistake.kanji}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="this.closest('.mistakes-modal-overlay').remove()">${t('btn_close')}</button>
                    </div>
                </div>
            `;

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // ESTAD√çSTICAS
        function updateStats() {
            document.getElementById('total-categories').textContent = categories.length;
            document.getElementById('total-words').textContent = 
                categories.reduce((sum, cat) => sum + cat.words.length, 0);
            document.getElementById('total-practiced').textContent = stats.totalPracticed;
        }

        // UTILIDADES
        function normalize(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .trim()
                .replace(/\s+/g, '');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'add-word-modal' && currentCategoryId) {
                viewCategory(currentCategoryId);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('vocabmaster_categories', JSON.stringify(categories));
                localStorage.setItem('vocabmaster_mistakes', JSON.stringify(mistakes));
                localStorage.setItem('vocabmaster_stats', JSON.stringify(stats));
                console.log('‚úÖ Data saved successfully to localStorage');
                console.log('Categories saved:', categories.length);
            } catch (error) {
                console.error('‚ùå Error saving to localStorage:', error);
                alert('Error saving data: ' + error.message);
            }
        }

        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Inicializar
        init();

        // Funci√≥n de diagn√≥stico (disponible en consola)
        window.debugVocabMaster = function() {
            console.log('=== VocabMaster Debug Info ===');
            console.log('localStorage available:', typeof(Storage) !== 'undefined');
            console.log('Categories in memory:', categories);
            console.log('Categories in localStorage:', localStorage.getItem('vocabmaster_categories'));
            console.log('Mistakes:', mistakes.length);
            console.log('History:', Object.keys(categoryHistory).length, 'categories with history');
            console.log('Current language:', currentLanguage);
            console.log('=============================');
        };

        console.log('üí° Tip: Type debugVocabMaster() in console for debug info');

        // Funci√≥n para copiar direcci√≥n BTC
        function copyBtcAddress(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = '‚úì Copied!';
                element.style.background = 'var(--success)';
                element.style.color = 'white';
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.background = '';
                    element.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
    </script>
</body>
</html>